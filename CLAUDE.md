# 五险一金计算器项目 - 上下文管理中枢

## 📋 项目概览

**项目名称**: 五险一金计算器
**技术栈**: Next.js + Tailwind CSS + Supabase
**部署平台**: Vercel
**项目状态**: 开发中 (Phase 1-7 完成)
**下一步**: Phase 8 - 测试部署
**当前阶段**: Phase 7 - 优化完善 (100% 完成)
**最后更新**: 2025-12-23

## 🎯 核心功能

1. **数据管理**: 通过Excel上传城市社保标准和员工工资数据
2. **自动计算**: 根据五险一金各项比例计算公司应缴费用
3. **用户认证**: 简单的登录系统，用户共享数据
4. **结果展示**: 分页、搜索、排序功能的数据表格
5. **进度跟踪**: 实时显示上传和计算进度

## 🏗️ 数据库设计

### cities 表 - 城市社保标准
```sql
- id: 主键
- city_name: 城市名 ('佛山')
- year: 年份 ('2025')
- base_min: 社保基数下限
- base_max: 社保基数上限
- [各项比例字段]: 养老、医疗、失业、工伤、生育、公积金
```

### salaries 表 - 员工工资
```sql
- id: 主键
- employee_id: 员工工号
- employee_name: 员工姓名
- month: 年份月份 (YYYYMM)
- salary_amount: 工资金额
```

### results 表 - 计算结果
```sql
- id: 主键
- employee_name: 员工姓名
- avg_salary: 年度月平均工资
- contribution_base: 最终缴费基数
- [各项金额]: 养老、医疗、失业、工伤、生育、公积金
- total_company: 公司总缴纳金额
```

## ⚙️ 核心业务逻辑

### 计算流程
1. 从salaries表按员工分组计算年度月平均工资
2. 获取佛山市社保标准（当前年份）
3. 确定缴费基数：平均工资与基数上下限比较
4. 分项计算五险一金金额
5. 存储到results表

### 缴费基数规则
```javascript
const contributionBase = Math.max(
  city.base_min,
  Math.min(avgSalary, city.base_max)
)
```

## 🎨 UI设计规范

### 主题风格
- **主色调**: 国家统计局蓝色 (#1e40af, #3b82f6)
- **布局**: 简洁卡片式布局
- **字体**: 系统默认字体栈

### 页面结构
- **主页**: 两个功能卡片（数据上传、结果查询）
- **上传页**: 文件上传 + 计算执行 + 进度显示
- **结果页**: 筛选条件 + 分页表格 + 导出功能

## 🔄 开发流程规范 - 强制执行

### 🚨 最高优先级规则

**任务完成后必须立即执行文档更新**，优先级高于所有其他操作：
1. **CHANGELOG.md 更新**：详细记录任务完成情况
2. **claude.md 更新**：同步项目状态和进度
3. **验证检查**：确保更新质量

### 📋 CHANGELOG.md 标准更新模板

每个 Task 完成后必须使用以下模板添加记录：

```markdown
### [YYYY-MM-DD] Task X: [任务标题] 完成
**版本**: v0.1.0-alpha
**阶段**: Phase X - [阶段名称] (Task X 完成)
**完成进度**: [X%]

#### ✅ Task X 完成情况

**任务目标**: [明确描述任务目标]
**实际用时**: 约 X 小时
**开始时间**: YYYY-MM-DD HH:MM
**完成时间**: YYYY-MM-DD HH:MM

#### 🔧 技术实现详情

**[实现部分1]**:
- [具体实现细节1]
- [具体实现细节2]

**[实现部分2]**:
- [具体实现细节1]
- [具体实现细节2]

#### 🎯 解决的核心问题

**[问题]**:
- **问题**: [具体问题描述]
- **解决方案**: [详细解决方案]
- **结果**: [最终实现效果]

#### 📁 创建的文件清单

**配置文件** (X个):
- `文件路径` - 文件描述
- `文件路径` - 文件描述

**源码文件** (X个):
- `文件路径` - 文件描述
- `文件路径` - 文件描述

#### ✅ 验证结果

**[测试项目]**:
```bash
[命令]  # ✅ 结果
```
- [测试结果1]
- [测试结果2]

#### 📊 技术栈更新

**新增依赖**:
- `[包名]`: 版本号

**配置更新**:
- [配置项1]: 具体变更

#### 🎉 下一阶段准备

**已完成 Phase X [完成数]/[总数] 任务 ([百分比] 完成)**:
- ✅ [已完成任务1]
- ✅ [已完成任务2]
- ⏳ [待完成任务1]
- ⏳ [待完成任务2]

**即将开始**: [下一任务标题]
```

### 📋 claude.md 标准更新内容

每个 Task 完成后必须同步更新：

1. **任务清单更新**：
   - 将完成 Task 标记为 `[x]`
   - 保持待完成 Task 为 `[ ]`

2. **项目状态更新**：
   - `**项目状态**: [开发中/已完成/暂停中]`
   - `**下一步**: [下一任务计划]`
   - `**当前阶段**: Phase [X] - [阶段描述] ([百分比] 完成)`
   - `**最后更新**: [当前日期]`

### 🔍 强制验证检查清单

每个 Task 完成后必须执行以下验证，确保 100% 通过：

#### CHANGELOG.md 验证
- [ ] 添加 Task 完成记录（使用标准模板）
- [ ] 更新项目状态概览（版本、阶段、进度）
- [ ] 更新里程碑状态（Phase 状态和进度）
- [ ] 记录创建的文件清单（分类统计）
- [ ] 包含验证结果和技术栈更新
- [ ] 格式检查（标题层级、代码块、表情符号）

#### claude.md 验证
- [ ] 更新任务清单（Task X 标记为完成）
- [ ] 更新项目状态（当前阶段、下一步计划）
- [ ] 更新完成进度
- [ ] 更新最后更新时间

#### 内容质量验证
- [ ] 任务描述清晰准确
- [ ] 技术实现细节完整
- [ ] 问题解决方案明确
- [ ] 时间统计准确
- [ ] 文件清单正确
- [ ] 验证结果可信

#### 格式一致性验证
- [ ] 遵循 Markdown 标题层级规范
- [ ] 代码块使用正确语言标识
- [ ] 表情符号使用一致
- [ ] 时间格式统一（YYYY-MM-DD HH:MM）
- [ ] 链接和引用正确

### ⚠️ 强制执行条款

**最高优先级规则**：
1. **文档更新优先级最高** - Task 完成后必须立即更新文档
2. **必须使用标准模板** - 不得自行修改格式或遗漏内容
3. **必须完成验证清单** - 确保所有检查项 100% 通过
4. **立即执行不延迟** - 不得延迟或跳过文档更新

**违规后果**：
- ❌ 未更新文档：Task 视为未完成，需要重新执行更新
- ❌ 格式不规范：必须重新格式化直至完全符合要求
- ❌ 验证未通过：继续完善直至所有检查项通过
- ❌ 执行不完整：补充遗漏的更新项，重新验证

### 🔄 自检机制

**AI 实例强制执行的自检流程**：
1. **Task 技术实现完成** → 功能 100% 实现
2. **立即查阅此规范** → 确认文档更新要求
3. **执行文档更新** → 按照标准模板更新两个文件
4. **执行验证清单** → 逐项检查，确保 100% 通过
5. **最终确认** → 所有检查项通过后方可标记 Task 完成

### ⚠️ 错误处理策略

**常见错误处理**：
- **遗漏更新**：立即补全相关内容，重新执行验证
- **格式错误**：按照标准模板重新格式化
- **内容不准确**：重新核实并修正信息
- **验证失败**：继续完善直至所有检查项通过

### 重要性
- **claude.md** 作为项目的"上下文管理中枢"，记录重要开发规则和流程要求
- **当上下文清除后，仍是执行的标准和准绳**
- **CHANGELOG.md** 作为项目的"执行记录账本"，跟踪所有执行细节
- **强制执行机制**：确保开发流程的一致性和质量

## 📝 开发任务清单 (TODO)

### Phase 1: 环境搭建 (Day 1)
- [x] 创建Next.js项目并配置Tailwind CSS (Task 1)
- [x] 配置Supabase客户端和连接 (Task 2)
- [x] 设置环境变量和项目配置 (Task 3)
- [x] 配置国家统计局UI主题色 (Task 4)
- [x] 创建基础项目结构 (Task 5)

### Phase 2: 认证与数据库 (Day 2)
- [x] 设置Supabase Auth
- [x] 创建数据库表结构
- [x] 实现登录/注册组件
- [x] 创建数据库类型定义

### Phase 3: 核心逻辑 (Day 3)
- [x] 实现计算函数 (Task 10)
- [x] 创建API路由 (Task 11)
- [x] 添加进度跟踪 (Task 12)
- [x] 错误处理完善 (Task 13)

### Phase 4: 主页开发 (Day 4)
- [x] 布局组件 (Task 14)
- [x] 主页卡片 (Task 15)
- [x] 响应式设计 (Task 16)
- [x] 用户认证状态 (Task 17)

### Phase 5: 数据上传 (Day 5-6)
- [x] Excel文件上传组件
- [x] 数据解析和验证
- [x] 批量数据插入
- [x] 上传进度显示

### Phase 6: 结果展示 (Day 7)
- [x] 数据表格组件
- [x] 分页和排序
- [x] 搜索筛选
- [x] Excel导出

### Phase 7: 优化完善 (Day 8)
- [x] 性能优化
- [x] 错误处理完善
- [x] 移动端适配
- [x] 用户体验优化

### Phase 8: 测试部署 (Day 9-10)
- [ ] 单元测试
- [ ] 端到端测试
- [ ] Vercel部署配置
- [ ] 生产环境验证

## 🔧 技术实现要点

### 文件处理
- 使用 `xlsx` 库解析Excel文件
- 支持拖拽上传
- 数据格式验证和错误提示

### 异步处理
- 计算过程异步执行
- 实时进度显示
- WebSocket或轮询机制

### 性能优化
- React.memo组件缓存
- 数据库查询分页
- 数据缓存机制

## 🚨 重要提醒

1. **数据验证**: Excel上传时必须验证格式和数值范围
2. **错误处理**: 完善的用户错误提示和恢复机制
3. **进度反馈**: 长时间操作必须显示进度
4. **响应式**: 确保移动端良好体验
5. **安全性**: 用户认证和数据访问控制

## 📊 项目指标

- 预计开发时间: 10天
- 核心页面: 4个 (主页、上传、结果、认证页面)
- 数据表: 3个主要表
- 支持格式: Excel (.xlsx)
- 部署平台: Vercel

---

**最后更新**: 2025-12-23
**项目状态**: 开发中 (Phase 1-7 完成)
**下一步**: Phase 8 - 测试部署
**当前阶段**: Phase 7 - 优化完善 (100% 完成)